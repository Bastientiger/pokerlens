<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poker Odds Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Empêche le rebond sur iOS et assure la taille fixe */
        html, body { 
            height: 100%; 
            overflow: hidden; 
            position: fixed; 
            width: 100%;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes slideInUp {
            from { transform: translateY(15px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-gauge { animation: slideInUp 0.5s ease-out forwards; }
    </style>
</head>
<body class="h-[100dvh] bg-[#0A0C11] text-slate-100 font-sans flex flex-col relative">
    <div class="absolute inset-0 pointer-events-none opacity-[0.03] bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]"></div>

    <div id="app" class="flex-1 flex flex-col w-full max-w-md mx-auto z-10 overflow-hidden">
        
        <div class="px-4 py-2 flex flex-col items-center gap-1.5 bg-[#0F1218]/90 border-b border-white/5 shrink-0">
            <div class="flex items-center gap-4 sm:gap-6">
                <div class="flex flex-col items-center gap-1">
                    <span class="text-[7px] font-black text-slate-600 uppercase tracking-widest">Hand</span>
                    <div class="flex gap-1.5" id="hole-container"></div>
                </div>
                <div class="flex flex-col items-center gap-1">
                    <span class="text-[7px] font-black text-slate-600 uppercase tracking-widest">Board</span>
                    <div class="flex gap-1" id="board-container"></div>
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col min-h-0 overflow-hidden px-4 py-3">
            <div class="flex justify-center mb-3 shrink-0">
                <div id="current-hand-badge" class="bg-[#FBBF24] text-black px-6 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest shadow-[0_0_15px_rgba(251,191,36,0.2)]">
                    CURRENT: HIGH
                </div>
            </div>

            <h2 class="text-[9px] font-black text-slate-500 uppercase tracking-[0.2em] mb-3 text-center shrink-0">PROBABILITIES</h2>

            <div id="gauges-container" class="flex-1 flex items-stretch justify-center gap-2 min-h-0">
                </div>
        </div>

        <div id="picker-area" class="bg-[#0F1218] border-t border-white/10 pt-3 pb-6 px-5 shadow-[0_-20px_50px_rgba(0,0,0,0.8)] shrink-0">
            </div>
    </div>

    <script>
        const SUITS = [
            { id: 's', symbol: '♠', color: 'text-black', pickerColor: 'text-white' },
            { id: 'h', symbol: '♥', color: 'text-red-600', pickerColor: 'text-red-500' },
            { id: 'd', symbol: '♦', color: 'text-red-600', pickerColor: 'text-red-500' },
            { id: 'c', symbol: '♣', color: 'text-black', pickerColor: 'text-white' },
        ];
        const RANKS = [
            { val: 14, label: 'A' }, { val: 13, label: 'K' }, { val: 12, label: 'Q' },
            { val: 11, label: 'J' }, { val: 10, label: '10' }, { val: 9, label: '9' },
            { val: 8, label: '8' }, { val: 7, label: '7' }, { val: 6, label: '6' },
            { val: 5, label: '5' }, { val: 4, label: '4' }, { val: 3, label: '3' }, { val: 2, label: '2' }
        ];
        const HAND_NAMES = ["HIGH", "PAIR", "2-PAIR", "TRIPS", "STRAIGHT", "FLUSH", "FULL HOUSE", "QUADS", "STR. FLUSH"];

        let state = {
            hole: [null, null],
            board: [null, null, null, null, null],
            activeSlot: { type: 'hole', index: 0 },
            pickingSuit: null,
            history: []
        };

        function evaluateHand(cards) {
            if (cards.length < 5) return 0;
            const sorted = [...cards].sort((a, b) => b.rank - a.rank);
            const ranks = sorted.map(c => c.rank);
            const suits = sorted.map(c => c.suit);
            const counts = {};
            ranks.forEach(r => counts[r] = (counts[r] || 0) + 1);
            const countValues = Object.values(counts).sort((a, b) => b - a);
            
            let isFlush = false, flushSuit = null;
            const suitCounts = {};
            suits.forEach(s => suitCounts[s] = (suitCounts[s] || 0) + 1);
            for (let s in suitCounts) { if (suitCounts[s] >= 5) { isFlush = true; flushSuit = s; } }

            const uniqueRanks = Array.from(new Set(ranks)).sort((a, b) => b - a);
            let isStraight = false;
            for (let i = 0; i <= uniqueRanks.length - 5; i++) {
                if (uniqueRanks[i] - uniqueRanks[i + 4] === 4) { isStraight = true; break; }
            }
            if (!isStraight && [14, 5, 4, 3, 2].every(r => uniqueRanks.includes(r))) isStraight = true;

            if (isFlush && isStraight) {
                const flushCards = sorted.filter(c => c.suit === flushSuit);
                const fRanks = Array.from(new Set(flushCards.map(c => c.rank))).sort((a, b) => b - a);
                for (let i = 0; i <= fRanks.length - 5; i++) { if (fRanks[i] - fRanks[i + 4] === 4) return 8; }
                if ([14, 5, 4, 3, 2].every(r => fRanks.includes(r))) return 8;
            }
            if (countValues[0] === 4) return 7;
            if (countValues[0] === 3 && countValues[1] >= 2) return 6;
            if (isFlush) return 5;
            if (isStraight) return 4;
            if (countValues[0] === 3) return 3;
            if (countValues[0] === 2 && countValues[1] === 2) return 2;
            if (countValues[0] === 2) return 1;
            return 0;
        }

        function calculateProbabilities() {
            const selected = [...state.hole, ...state.board].filter(Boolean);
            const fullBoard = state.board.filter(Boolean);
            if (!state.hole.every(Boolean) || fullBoard.length < 3) return null;

            const deck = [];
            RANKS.forEach(r => SUITS.forEach(s => {
                if (!selected.some(c => c.rank === r.val && c.suit === s.id)) deck.push({ rank: r.val, suit: s.id });
            }));

            const results = new Array(9).fill(0);
            let totalSims = 0;
            const missing = 5 - fullBoard.length;

            if (missing === 0) {
                results[evaluateHand([...state.hole, ...fullBoard])]++;
                totalSims = 1;
            } else if (missing === 1) {
                deck.forEach(c1 => { results[evaluateHand([...state.hole, ...fullBoard, c1])]++; totalSims++; });
            } else if (missing === 2) {
                for (let i = 0; i < deck.length; i++) {
                    for (let j = i + 1; j < deck.length; j++) {
                        results[evaluateHand([...state.hole, ...fullBoard, deck[i], deck[j]])]++;
                        totalSims++;
                    }
                }
            }
            return results.map(count => (count / totalSims) * 100);
        }

        function render() {
            // Hole Cards
            document.getElementById('hole-container').innerHTML = state.hole.map((c, i) => 
                createCardHtml(c, `H${i+1}`, state.activeSlot.type === 'hole' && state.activeSlot.index === i, false, `selectSlot('hole', ${i})`)
            ).join('');
            
            // Board Cards
            document.getElementById('board-container').innerHTML = state.board.map((c, i) => 
                createCardHtml(c, i < 3 ? "F" : i === 3 ? "T" : "R", state.activeSlot.type === 'board' && state.activeSlot.index === i, true, `selectSlot('board', ${i})`)
            ).join('');

            const currentRank = evaluateHand([...state.hole, ...state.board].filter(Boolean));
            document.getElementById('current-hand-badge').innerText = `CURRENT: ${HAND_NAMES[currentRank]}`;

            renderGauges();
            renderPicker();
            lucide.createIcons();
        }

        function createCardHtml(card, label, isActive, isBoard, onClick) {
            const activeClass = isActive ? 'ring-2 ring-amber-400 scale-105 z-10 shadow-[0_0_15px_rgba(251,191,36,0.3)]' : 'ring-1 ring-white/10';
            const bgClass = card ? 'bg-white shadow-lg' : 'bg-slate-900/40 border border-slate-800 border-dashed';
            const sizeClass = isBoard ? 'w-8 h-11 sm:w-11 sm:h-16' : 'w-11 h-16 sm:w-14 sm:h-20';
            
            let content = `<span class="text-[6px] text-slate-500 font-black uppercase opacity-60">${label}</span>`;
            if (card) {
                const s = SUITS.find(s => s.id === card.suit);
                const r = RANKS.find(r => r.val === card.rank);
                content = `
                    <div class="flex flex-col items-center justify-center leading-none">
                        <span class="${isBoard ? 'text-xs' : 'text-sm'} font-black ${s.color}">${r.label}</span>
                        <span class="${isBoard ? 'text-lg' : 'text-xl'} ${s.color}">${s.symbol}</span>
                    </div>`;
            }
            return `<button onclick="${onClick}" class="relative rounded flex flex-col items-center justify-center transition-all ${sizeClass} ${activeClass} ${bgClass}">${content}</button>`;
        }

        function renderGauges() {
            const container = document.getElementById('gauges-container');
            const probs = calculateProbabilities();

            if (!probs) {
                container.innerHTML = `
                    <div class="w-full flex flex-col items-center justify-center border border-slate-800/20 border-dashed rounded-[20px] bg-slate-900/10">
                        <i data-lucide="info" class="text-slate-800 mb-2 w-5"></i>
                        <p class="text-[9px] uppercase font-bold text-slate-700 text-center px-6">Add cards to see odds</p>
                    </div>`;
                return;
            }

            container.innerHTML = probs.map((prob, idx) => {
                if (prob <= 0) return '';
                return `
                    <div class="flex flex-col items-center flex-1 max-w-[45px] animate-gauge">
                        <span class="text-[9px] font-mono font-black text-[#FBBF24] mb-1">${prob >= 99.9 ? "100" : prob.toFixed(prob < 5 ? 1 : 0)}%</span>
                        <div class="flex-1 w-full bg-[#11141B] rounded border border-white/5 relative flex flex-col justify-end overflow-hidden">
                            <div class="w-full bg-[#FBBF24] transition-all duration-700 shadow-[0_0_10px_rgba(251,191,36,0.2)]" style="height: ${prob}%"></div>
                        </div>
                        <span class="text-[7px] font-black uppercase tracking-tighter text-slate-500 mt-1 text-center leading-tight h-5 flex items-center">${HAND_NAMES[idx]}</span>
                    </div>`;
            }).join('');
        }

        function renderPicker() {
            const area = document.getElementById('picker-area');
            let content = "";

            if (!state.pickingSuit) {
                content = `
                    <div class="flex flex-col gap-2">
                        <span class="text-[7px] font-black text-slate-600 uppercase tracking-[0.2em] text-center">Step 1: Suit</span>
                        <div class="grid grid-cols-4 gap-3">
                            ${SUITS.map(s => `
                                <button onclick="setSuit('${s.id}')" class="h-10 bg-slate-800/40 rounded-lg flex items-center justify-center border border-white/5 active:scale-95 transition-all">
                                    <span class="text-2xl ${s.pickerColor}">${s.symbol}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>`;
            } else {
                const suit = SUITS.find(s => s.id === state.pickingSuit);
                const usedInDeck = [...state.hole, ...state.board].filter(Boolean);
                content = `
                    <div class="flex flex-col gap-2">
                        <div class="flex justify-between items-center mb-1">
                            <button onclick="setSuit(null)" class="text-slate-500 flex items-center gap-1">
                                <i data-lucide="chevron-left" class="w-3"></i><span class="text-[8px] font-black uppercase">Back</span>
                            </button>
                            <span class="text-[7px] font-black text-slate-600 uppercase tracking-[0.2em]">Step 2: Rank</span>
                            <span class="text-lg ${suit.pickerColor}">${suit.symbol}</span>
                        </div>
                        <div class="grid grid-cols-7 gap-1">
                            ${RANKS.map(r => {
                                const used = usedInDeck.some(c => c.rank === r.val && c.suit === state.pickingSuit);
                                return `<button ${used ? 'disabled' : ''} onclick="pickRank(${r.val})" class="h-8 rounded text-[10px] font-black ${used ? 'bg-black text-slate-900 opacity-20' : 'bg-slate-800 text-slate-300 active:bg-[#FBBF24] active:text-black'}">${r.label}</button>`;
                            }).join('')}
                        </div>
                    </div>`;
            }
            
            area.innerHTML = content + `
                <div class="flex justify-center gap-20 border-t border-white/5 mt-4 pt-3">
                    <button onclick="undo()" class="flex flex-col items-center gap-1 text-slate-500 active:text-white">
                        <i data-lucide="undo" class="w-4"></i><span class="text-[7px] font-black uppercase">Undo</span>
                    </button>
                    <button onclick="reset()" class="flex flex-col items-center gap-1 text-slate-500 active:text-red-500">
                        <i data-lucide="rotate-ccw" class="w-4"></i><span class="text-[7px] font-black uppercase">Reset</span>
                    </button>
                </div>`;
        }

        window.selectSlot = (type, index) => { state.activeSlot = { type, index }; state.pickingSuit = null; render(); };
        window.setSuit = (suitId) => { state.pickingSuit = suitId; render(); };
        window.pickRank = (rank) => {
            if (!state.pickingSuit) return;
            state.history.push(JSON.parse(JSON.stringify({ hole: state.hole, board: state.board, activeSlot: state.activeSlot })));
            if (state.activeSlot.type === 'hole') {
                state.hole[state.activeSlot.index] = { rank, suit: state.pickingSuit };
                if (state.activeSlot.index === 0) state.activeSlot.index = 1;
                else state.activeSlot = { type: 'board', index: 0 };
            } else {
                state.board[state.activeSlot.index] = { rank, suit: state.pickingSuit };
                if (state.activeSlot.index < 4) state.activeSlot.index++;
            }
            state.pickingSuit = null;
            render();
        };
        window.undo = () => { if (state.history.length > 0) { const last = state.history.pop(); state.hole = last.hole; state.board = last.board; state.activeSlot = last.activeSlot; state.pickingSuit = null; render(); } };
        window.reset = () => { state = { hole: [null, null], board: [null, null, null, null, null], activeSlot: { type: 'hole', index: 0 }, pickingSuit: null, history: [] }; render(); };

        render();
    </script>
</body>
</html>
