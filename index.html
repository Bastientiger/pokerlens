import React, { useState, useMemo } from 'react';
import { Undo, RotateCcw, ChevronLeft, Info } from 'lucide-react';

// --- Poker Engine Constants ---
const SUITS = [
  { id: 's', symbol: '♠', color: 'text-black', pickerColor: 'text-white', label: 'Spades' },
  { id: 'h', symbol: '♥', color: 'text-red-600', pickerColor: 'text-red-500', label: 'Hearts' },
  { id: 'd', symbol: '♦', color: 'text-red-600', pickerColor: 'text-red-500', label: 'Diamonds' },
  { id: 'c', symbol: '♣', color: 'text-black', pickerColor: 'text-white', label: 'Clubs' },
];

const RANKS = [
  { val: 14, label: 'A' }, { val: 13, label: 'K' }, { val: 12, label: 'Q' },
  { val: 11, label: 'J' }, { val: 10, label: '10' }, { val: 9, label: '9' },
  { val: 8, label: '8' }, { val: 7, label: '7' }, { val: 6, label: '6' },
  { val: 5, label: '5' }, { val: 4, label: '4' }, { val: 3, label: '3' },
  { val: 2, label: '2' }
];

const HAND_NAMES = [
  "HIGH", "PAIR", "2-PAIR", "TRIPS", 
  "STRAIGHT", "FLUSH", "FULL HOUSE", "QUADS", "STR. FLUSH"
];

// --- Hand Evaluation Logic ---
const evaluateHand = (cards) => {
  if (cards.length < 5) return 0;
  const sorted = [...cards].sort((a, b) => b.rank - a.rank);
  const ranks = sorted.map(c => c.rank);
  const suits = sorted.map(c => c.suit);
  const counts = {};
  ranks.forEach(r => counts[r] = (counts[r] || 0) + 1);
  const countValues = Object.values(counts).sort((a, b) => b - a);
  
  let isFlush = false;
  let flushSuit = null;
  const suitCounts = {};
  suits.forEach(s => suitCounts[s] = (suitCounts[s] || 0) + 1);
  for (let s in suitCounts) { if (suitCounts[s] >= 5) { isFlush = true; flushSuit = s; } }

  const uniqueRanks = Array.from(new Set(ranks)).sort((a, b) => b - a);
  let isStraight = false;
  for (let i = 0; i <= uniqueRanks.length - 5; i++) {
    if (uniqueRanks[i] - uniqueRanks[i + 4] === 4) { isStraight = true; break; }
  }
  if (!isStraight && [14, 5, 4, 3, 2].every(r => uniqueRanks.includes(r))) isStraight = true;

  if (isFlush && isStraight) {
    const flushCards = sorted.filter(c => c.suit === flushSuit);
    const fRanks = Array.from(new Set(flushCards.map(c => c.rank))).sort((a, b) => b - a);
    for (let i = 0; i <= fRanks.length - 5; i++) { if (fRanks[i] - fRanks[i + 4] === 4) return 8; }
    if ([14, 5, 4, 3, 2].every(r => fRanks.includes(r))) return 8;
  }

  if (countValues[0] === 4) return 7;
  if (countValues[0] === 3 && countValues[1] >= 2) return 6;
  if (isFlush) return 5;
  if (isStraight) return 4;
  if (countValues[0] === 3) return 3;
  if (countValues[0] === 2 && countValues[1] === 2) return 2;
  if (countValues[0] === 2) return 1;
  return 0;
};

const Card = ({ card, active, onClick, label, isBoard }) => {
  const suitInfo = card ? SUITS.find(s => s.id === card.suit) : null;
  const rankInfo = card ? RANKS.find(r => r.val === card.rank) : null;
  
  return (
    <button
      onClick={onClick}
      className={`relative rounded-lg flex flex-col items-center justify-center transition-all duration-200
        ${isBoard ? 'w-9 h-12 sm:w-11 sm:h-16' : 'w-12 h-18 sm:w-14 sm:h-20'}
        ${active ? 'ring-2 ring-amber-400 scale-105 z-10 shadow-[0_0_20px_rgba(251,191,36,0.3)]' : 'ring-1 ring-white/10'}
        ${card ? 'bg-white shadow-xl' : 'bg-slate-900/40 border border-slate-800 border-dashed'}
      `}
    >
      {card ? (
        <div className="flex flex-col items-center justify-center h-full w-full">
          <span className={`${isBoard ? 'text-sm' : 'text-base'} font-black text-center leading-none mb-0.5 ${suitInfo.color}`}>
            {rankInfo?.label}
          </span>
          <span className={`text-xl sm:text-2xl leading-none ${suitInfo.color}`}>
            {suitInfo.symbol}
          </span>
        </div>
      ) : (
        <span className="text-[6px] text-slate-500 font-black uppercase opacity-60 text-center px-1 leading-tight">
          {label}
        </span>
      )}
    </button>
  );
};

export default function App() {
  const [hole, setHole] = useState([null, null]);
  const [board, setBoard] = useState([null, null, null, null, null]);
  const [activeSlot, setActiveSlot] = useState({ type: 'hole', index: 0 });
  const [pickingSuit, setPickingSuit] = useState(null); 
  const [history, setHistory] = useState([]);

  const selectedCards = [...hole, ...board].filter(Boolean);
  const currentHandRank = useMemo(() => evaluateHand(selectedCards), [selectedCards]);

  const deck = useMemo(() => {
    const d = [];
    RANKS.forEach(r => {
      SUITS.forEach(s => {
        if (!selectedCards.some(c => c.rank === r.val && c.suit === s.id)) {
          d.push({ rank: r.val, suit: s.id });
        }
      });
    });
    return d;
  }, [selectedCards]);

  const probabilities = useMemo(() => {
    const fullBoard = board.filter(Boolean);
    const hasHole = hole.every(Boolean);
    if (!hasHole || fullBoard.length < 3) return null;

    const results = new Array(9).fill(0);
    let totalSims = 0;
    const missingCount = 5 - fullBoard.length;

    if (missingCount === 0) {
      results[evaluateHand([...hole, ...fullBoard])]++;
      totalSims = 1;
    } else if (missingCount === 1) {
      deck.forEach(c1 => {
        results[evaluateHand([...hole, ...fullBoard, c1])]++;
        totalSims++;
      });
    } else if (missingCount === 2) {
      for (let i = 0; i < deck.length; i++) {
        for (let j = i + 1; j < deck.length; j++) {
          results[evaluateHand([...hole, ...fullBoard, deck[i], deck[j]])]++;
          totalSims++;
        }
      }
    }
    return results.map(count => (count / totalSims) * 100);
  }, [hole, board, deck]);

  const handleSlotClick = (type, index) => {
    setActiveSlot({ type, index });
    setPickingSuit(null); 
  };

  const selectCard = (rank) => {
    if (!pickingSuit) return;
    const newCard = { rank, suit: pickingSuit };
    setHistory(prev => [...prev, { hole, board, activeSlot }]);
    
    if (activeSlot.type === 'hole') {
      const newHole = [...hole];
      newHole[activeSlot.index] = newCard;
      setHole(newHole);
      if (activeSlot.index === 0) {
        setActiveSlot({ type: 'hole', index: 1 });
        setPickingSuit(null);
      } else {
        setActiveSlot({ type: 'board', index: 0 });
        setPickingSuit(null);
      }
    } else {
      const newBoard = [...board];
      newBoard[activeSlot.index] = newCard;
      setBoard(newBoard);
      if (activeSlot.index < 4) {
        setActiveSlot({ type: 'board', index: activeSlot.index + 1 });
        setPickingSuit(null);
      }
    }
  };

  const undo = () => {
    if (history.length === 0) return;
    const last = history[history.length - 1];
    setHole(last.hole); setBoard(last.board); setActiveSlot(last.activeSlot);
    setPickingSuit(null);
    setHistory(prev => prev.slice(0, -1));
  };

  const reset = () => {
    setHole([null, null]); setBoard([null, null, null, null, null]);
    setActiveSlot({ type: 'hole', index: 0 }); setPickingSuit(null); setHistory([]);
  };

  const isCardUsed = (rank, suit) => selectedCards.some(c => c.rank === rank && c.suit === suit);

  return (
    <div className="h-screen bg-[#0A0C11] text-slate-100 font-sans flex flex-col overflow-hidden relative">
      <div className="absolute inset-0 pointer-events-none opacity-[0.03] bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]"></div>

      <div className="flex-1 flex flex-col w-full max-w-md mx-auto z-10 overflow-hidden">
        
        {/* --- CARDS SECTION (COMPACTED) --- */}
        <div className="px-4 py-2 flex flex-col items-center gap-2 bg-[#0F1218]/80 border-b border-white/5">
          <div className="flex items-center gap-6">
            <div className="flex flex-col items-center gap-1">
              <span className="text-[7px] font-black text-slate-600 uppercase tracking-widest">Hand</span>
              <div className="flex gap-2">
                {hole.map((c, i) => (
                  <Card key={`hole-${i}`} card={c} label={`H${i+1}`} active={activeSlot.type === 'hole' && activeSlot.index === i} onClick={() => handleSlotClick('hole', i)} />
                ))}
              </div>
            </div>
            <div className="flex flex-col items-center gap-1">
              <span className="text-[7px] font-black text-slate-600 uppercase tracking-widest">Board</span>
              <div className="flex gap-1.5">
                {[0, 1, 2, 3, 4].map(i => (
                  <Card key={`board-${i}`} card={board[i]} label={i < 3 ? "F" : i === 3 ? "T" : "R"} isBoard active={activeSlot.type === 'board' && activeSlot.index === i} onClick={() => handleSlotClick('board', i)} />
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* --- PROBABILITIES AREA (ENLARGED) --- */}
        <div className="flex-1 flex flex-col overflow-hidden px-4 py-4">
          <div className="flex justify-center mb-4 shrink-0">
            <div className="bg-[#FBBF24] text-black px-8 py-2.5 rounded-full text-[11px] font-black uppercase tracking-widest shadow-[0_0_20px_rgba(251,191,36,0.2)]">
              CURRENT: {HAND_NAMES[currentHandRank]}
            </div>
          </div>

          <h2 className="text-[11px] font-black text-slate-500 uppercase tracking-[0.2em] mb-4 text-center shrink-0">FINAL PROBABILITIES (RIVER)</h2>

          {/* Tall Gauges Section */}
          <div className="flex-1 flex items-stretch justify-center gap-2 sm:gap-3 px-1 min-h-0">
            {!probabilities ? (
              <div className="w-full flex flex-col items-center justify-center border border-slate-800/20 border-dashed rounded-[32px] bg-slate-900/10">
                <Info size={24} className="text-slate-800 mb-3" />
                <p className="text-[10px] uppercase font-bold tracking-[0.1em] text-slate-700 text-center px-10 leading-tight">
                  Enter cards to calculate tall real-time gauges
                </p>
              </div>
            ) : (
              probabilities.map((prob, idx) => {
                if (prob <= 0) return null;
                
                return (
                  <div key={idx} className="flex flex-col items-center flex-1 max-w-[50px] animate-in slide-in-from-bottom-8 duration-700">
                    {/* Top percentage text */}
                    <div className="h-6 flex items-center justify-center mb-1 shrink-0">
                      <span className="text-[11px] font-mono font-black text-[#FBBF24]">
                        {prob >= 99.9 ? "100" : prob.toFixed(prob < 10 && prob > 0 ? 1 : 0)}%
                      </span>
                    </div>
                    
                    {/* ENLARGED Gauge Container */}
                    <div className="flex-1 w-full bg-[#11141B] rounded-md border border-white/5 relative flex flex-col justify-end overflow-hidden shadow-inner">
                      {/* Gauge Fill - Solid Amber */}
                      <div 
                        className="w-full bg-[#FBBF24] transition-all duration-1000 ease-out shadow-[0_0_15px_rgba(251,191,36,0.3)]" 
                        style={{ height: `${Math.min(prob, 100)}%` }} 
                      >
                        {/* Shimmer effect */}
                        <div className="absolute top-0 left-0 w-full h-8 bg-gradient-to-b from-white/10 to-transparent pointer-events-none"></div>
                      </div>
                    </div>
                    
                    {/* Bottom Hand Name */}
                    <div className="h-10 flex items-center justify-center w-full px-0.5 mt-2 shrink-0">
                      <span className="text-[8px] font-black uppercase tracking-tighter text-slate-400 text-center leading-tight">
                        {HAND_NAMES[idx]}
                      </span>
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>

        {/* --- CARD PICKER (ANCHORED) --- */}
        <div className="bg-[#0F1218] border-t border-white/10 pt-3 pb-8 px-5 shadow-[0_-20px_60px_rgba(0,0,0,0.9)] shrink-0">
          {!pickingSuit ? (
            <div className="flex flex-col gap-3">
              <span className="text-[8px] font-black text-slate-600 uppercase tracking-widest text-center">Step 1: Select Suit</span>
              <div className="grid grid-cols-4 gap-4">
                {SUITS.map(s => (
                  <button key={s.id} onClick={() => setPickingSuit(s.id)} className="h-11 bg-slate-800/40 hover:bg-slate-700 rounded-xl flex items-center justify-center border border-white/5 transition-all active:scale-90 shadow-inner group">
                    <span className={`text-2xl ${s.pickerColor} group-active:scale-110 transition-transform`}>{s.symbol}</span>
                  </button>
                ))}
              </div>
            </div>
          ) : (
            <div className="flex flex-col gap-2">
              <div className="flex justify-between items-center px-1 mb-1">
                <button onClick={() => setPickingSuit(null)} className="text-slate-500 hover:text-white flex items-center gap-1 transition-colors group">
                  <ChevronLeft size={16} /> 
                  <span className="text-[8px] font-black uppercase tracking-wider">Back</span>
                </button>
                <div className="flex items-center gap-2">
                  <span className={`text-lg leading-none ${SUITS.find(s => s.id === pickingSuit).pickerColor}`}>{SUITS.find(s => s.id === pickingSuit).symbol}</span>
                  <span className="text-[8px] font-black text-slate-600 uppercase tracking-widest">Select Rank</span>
                </div>
              </div>
              <div className="grid grid-cols-7 gap-1.5">
                {RANKS.map(r => {
                  const used = isCardUsed(r.val, pickingSuit);
                  return (
                    <button key={r.val} disabled={used} onClick={() => selectCard(r.val)} className={`h-8 rounded-lg flex items-center justify-center text-[11px] font-black transition-all ${used ? 'bg-black text-slate-900 opacity-20' : 'bg-slate-800 text-slate-300 active:bg-[#FBBF24] active:text-black hover:bg-slate-700'}`}>
                      {r.label}
                    </button>
                  );
                })}
              </div>
            </div>
          )}

          <div className="flex justify-center gap-24 border-t border-white/5 mt-5 pt-4">
            <button onClick={undo} className="flex flex-col items-center gap-1 text-slate-500 hover:text-white transition-colors group">
              <Undo size={18} className="group-active:scale-90 transition-transform" /> 
              <span className="text-[8px] font-black uppercase tracking-[0.2em]">Undo</span>
            </button>
            <button onClick={reset} className="flex flex-col items-center gap-1 text-slate-500 hover:text-red-500 transition-colors group">
              <RotateCcw size={18} className="group-active:rotate-[-45deg] transition-transform" /> 
              <span className="text-[8px] font-black uppercase tracking-[0.2em]">Reset</span>
            </button>
          </div>
        </div>

      </div>

      <style dangerouslySetInnerHTML={{ __html: `
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      `}} />
    </div>
  );
}
